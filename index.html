<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.21.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
    </style>
</head>
<body>

<style>
.coordinates {
    background: rgba(0,0,0,0.5);
    color: #fff;
    position: absolute;
    bottom: 10px;
    left: 10px;
    padding:5px 10px;
    margin: 0;
    font-size: 11px;
    line-height: 18px;
    border-radius: 3px;
    display: none;
}
</style>



<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.0/mapbox-gl-geocoder.js'></script>
<script src="turf_SatJul302016.min.js" charset="utf-8"></script>
<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v1.3.0/mapbox-gl-geocoder.css' type='text/css' />

<div id='map'></div>
<pre id='coordinates' class='coordinates'></pre>
<script src="buildings.geojson" type="text/javascript"></script>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibGF1cmVuY2VuaWNvbCIsImEiOiJjaW8zdWNwaW8wMWN1dzNramw2ZGVwZDIxIn0.ypTc0f_ote92hBKe3BzKuw';

var coordinates = document.getElementById('coordinates');

// GeoJSON object to hold our measurement features
var geojson = {
    "type": "FeatureCollection",
    "features": []
};

var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v9', //stylesheet location
    center: [144.96546591, -37.8186610515], // starting position
    zoom: 12 // starting zoom
});

var geocoder = new mapboxgl.Geocoder();
map.addControl(geocoder);

// Add zoom and rotation controls to the map.
map.addControl(new mapboxgl.Navigation({position: 'top-left'}));

map.on('load', function () {
    var result = {
      "type": "FeatureCollection",
      "features": []
    };
    map.addSource('circle', {
        type: 'geojson',
        data: result
    });
    map.addLayer({
        id: 'circle',
        type: 'fill',
        source: 'circle',
    });

    map.addSource('geojson', {
        type: 'geojson',
        data: geojson
    });

    // Add styles to the map
    map.addLayer({
        id: 'points',
        type: 'circle',
        source: 'geojson',
        paint: {
            'circle-radius': 5,
            'circle-color': '#007cbf'
        }
    });

    map.addSource("melbourne-buildings", {
        type: "geojson",
        data: buildings
    });

    map.addLayer({
        "id": "melbourne-buildings",
        "type": "circle",
        "source": "melbourne-buildings",    
        'paint': {
            // make circles larger as the user zooms from z12 to z22
            'circle-radius': {
                'base': 1.75,
                'stops': [[12, 2], [22, 180]]
            },
            // color circles by ethnicity, using data-driven styles
            'circle-color': {
                property: "Number of floors (above ground)",
                stops: [[0, '#f1f075'], [50, '#e55e5e']]
            }
        }
    });
});

// Listen for the `geocoder.input` event that is triggered when a user
// makes a selection and add a symbol that matches the result.
geocoder.on('result', function(ev) {
    if (geojson.features.length > 0) geojson.features.pop();
    geojson.features.push(ev.result);
    map.getSource('geojson').setData(geojson);

    coords = ev.result.geometry.coordinates

    var center = {
      "type": "Feature",
      "properties": {
        "marker-color": "#0f0"
      },
      "geometry": {
        "type": "Point",
        "coordinates": coords
      }
    };

    var radius = 0.100;
    var steps = 20;
    var units = 'kilometers';

    var circle = turf.circle(center, radius, steps, units);

    var circle_collection = {type: "FeatureCollection", features: [circle]}

    map.getSource('circle').setData(circle);

    console.log(buildings)
    console.log(circle)
    var points_within = turf.within(buildings, circle_collection)

    console.log(points_within.features.length);

    // Print the coordinates of where the point had
    // finished being dragged to on the map.
    coordinates.style.display = 'block';
    coordinates.innerHTML = 'Longitude: ' + coords[0] + '<br />Latitude: ' + coords[1];
});

map.on('click', function(e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['points'] });

    // If a feature was clicked, remove it from the map
    if (features.length) {
        var id = features[0].properties.id;
        geojson.features = geojson.features.filter(function(point) {
            return point.properties.id !== id;
        });
        map.getSource('geojson').setData(geojson);
    } else {
        geocoder.query([e.lngLat.lng, e.lngLat.lat])
    }
});

// Use the same approach as above to indicate that the symbols are clickable
// by changing the cursor style to 'pointer'.
map.on('mousemove', function (e) {
    var features = map.queryRenderedFeatures(e.point, { layers: ['points'] });
    map.getCanvas().style.cursor = (features.length) ? 'pointer' : 'crosshair';
});

</script>

</body>
</html>